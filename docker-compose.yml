version: '3.8'

services:
  # MongoDB база данных
  mongodb:
    image: mongo:4.4
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    command: [--replSet, rs0]
    networks:
      - events_network
    healthcheck:
      test: echo "try { rs.status() } catch (err) { rs.initiate({_id:'rs0',members:[{_id:0,host:'87.222.87.72:27017'}]}) }" | mongosh --port 27017 --quiet
      interval: 5s
      start_period: 10s
      retries: 30

  # FastAPI приложение
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: events_api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - MONGODB_URI=mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-admin123}@mongodb:27017/${MONGODB_DB_NAME:-events_db}?authSource=admin
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-events_db}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      - API_HOST=0.0.0.0
      - API_PORT=8000
    env_file:
      - .env
    volumes:
      - ./images:/app/images
      - ./logs:/app/logs
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - events_network
    command: python run_api.py

  # AI процессор (однократная обработка, для ручного запуска)
  ai_processor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: events_ai_processor
    restart: "no"
    environment:
      - MONGODB_URI=mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-admin123}@mongodb:27017/${MONGODB_DB_NAME:-events_db}?authSource=admin
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-events_db}
      - IMAGES_DIR=images
    env_file:
      - .env
    volumes:
      - ./images:/app/images
      - ./logs:/app/logs
      - ./telegram_parser_session.session:/app/telegram_parser_session.session
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - events_network
    command: python run_ai_processor.py
    profiles:
      - manual  # Запускается только с --profile manual

  # Telegram парсер (опционально, можно запускать отдельно)
  telegram_parser:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: events_telegram_parser
    restart: unless-stopped
    environment:
      - MONGODB_URI=mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-admin123}@mongodb:27017/${MONGODB_DB_NAME:-events_db}?authSource=admin
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-events_db}
      - IMAGES_DIR=images
    env_file:
      - .env
    volumes:
      - ./images:/app/images
      - ./logs:/app/logs
      - ./telegram_parser_session.session:/app/telegram_parser_session.session
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - events_network
    command: python run_parser.py
    profiles:
      - parser  # Запускается только с --profile parser

  # Telegram Parser Scheduler (планировщик парсинга)
  telegram_scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: events_telegram_scheduler
    restart: unless-stopped
    environment:
      - MONGODB_URI=mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-admin123}@mongodb:27017/${MONGODB_DB_NAME:-events_db}?authSource=admin
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-events_db}
      - IMAGES_DIR=images
    env_file:
      - .env
    volumes:
      - ./images:/app/images
      - ./logs:/app/logs
      - ./telegram_parser_session.session:/app/telegram_parser_session.session
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - events_network
    command: python run_scheduler.py
    profiles:
      - scheduler  # Запускается только с --profile scheduler

  # AI Processor Scheduler (планировщик обработки постов)
  ai_processor_scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: events_ai_processor_scheduler
    restart: unless-stopped
    environment:
      - MONGODB_URI=mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-admin123}@mongodb:27017/${MONGODB_DB_NAME:-events_db}?authSource=admin
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-events_db}
      - IMAGES_DIR=images
    env_file:
      - .env
    volumes:
      - ./images:/app/images
      - ./logs:/app/logs
      - ./telegram_parser_session.session:/app/telegram_parser_session.session
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - events_network
    command: python run_ai_processor_scheduler.py
    profiles:
      - scheduler  # Запускается только с --profile scheduler

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

networks:
  events_network:
    driver: bridge

